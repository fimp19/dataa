<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SwiftData - Buy Data</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body{background:linear-gradient(135deg,#4e73df,#1cc88a);min-height:100vh;color:#fff;font-family:Arial,Helvetica,sans-serif}
    .page{max-width:900px;margin:36px auto;padding:18px}
    .card{background:rgba(0,0,0,0.35);padding:18px;border-radius:12px}
    label{color:#ddd;font-weight:600}
    input[readonly]{background:rgba(255,255,255,0.06);color:#fff;border:1px solid rgba(255,255,255,0.06)}
    .plans { margin-top:14px; display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    .plan-btn { padding:12px;border-radius:10px;border:0; cursor:pointer; font-weight:700; }
    .plan-btn:hover{transform:translateY(-3px)}
    .no-plans { color:#ffd; text-align:center; padding:12px; }
  </style>
</head>
<body>
  <div class="page">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="m-0"><i class="fa-solid fa-wifi"></i> Buy Data</h3>
      <a href="home.html" class="btn btn-sm btn-outline-light">â¬… Back</a>
    </div>

    <div class="card">
      <div class="mb-3">
        <label for="phone">Your Phone Number</label>
        <input id="phone" class="form-control" readonly>
      </div>

      <!-- Detected Network -->
<div style="display:flex; align-items:center; gap:10px; margin:10px 0;">
  <img id="networkLogo" src="" alt="Network Logo" style="width:30px; height:30px; display:none;">
  <span id="detectedNetwork" style="font-weight:bold; font-size:16px;"></span>
</div>


      <div id="plansContainer">
        <p class="no-plans">Plans will appear here after detection.</p>
        <div id="plans" class="plans"></div>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Get saved user
  let savedUser = JSON.parse(localStorage.getItem("user")) || null;
  if (!savedUser || !savedUser.phone) {
    alert("No user found. Please sign in again.");
    window.location.href = "signin.html";
    return;
  }

  const phoneInput = document.getElementById("phone");
  const networkInput = document.getElementById("network");
  const plansDiv = document.getElementById("plans");
  const plansContainer = document.getElementById("plansContainer");

  // normalize phone
  function normalizePhone(raw) {
    if (!raw) return '';
    let s = String(raw).trim();
    s = s.replace(/[\s\-()]/g,'');
    if (s.startsWith('+234')) s = '0' + s.slice(4);
    else if (s.startsWith('234')) s = '0' + s.slice(3);
    return s;
  }

  // detect network by prefix
  function detectNetwork(phone) {
  let network = "";
  let logo = "";

  if (/^0803|^0806|^0703|^0706|^0813|^0816|^0810|^0814|^0903|^0906|^0913|^0916/.test(phone)) {
    network = "MTN";
    logo = "./image/MTN.jpg";
  } 
  else if (/^0805|^0807|^0705|^0815|^0811|^0905|^0915/.test(phone)) {
    network = "Glo";
    logo = "images/GLO.png";
  } 
  else if (/^0802|^0808|^0708|^0812|^0701|^0902|^0901|^0907|^0912/.test(phone)) {
    network = "Airtel";
    logo = "images/artel.jpg";
  } 
  else if (/^0809|^0817|^0818|^0909|^0908/.test(phone)) {
    network = "9mobile";
    logo = "images/9mobile-logo_2.jpg";
  }

  // Update UI
  document.getElementById("detectedNetwork").textContent = network;

  if (logo) {
    let logoImg = document.getElementById("networkLogo");
    logoImg.src = logo;
    logoImg.style.display = "inline-block";
  } else {
    document.getElementById("networkLogo").style.display = "none";
  }

  // ðŸš€ Auto-load plans for the detected network
  if (network) {
    loadPlans(network);
  } else {
    document.getElementById("plansContainer").innerHTML = "<p class='text-danger'>Invalid number</p>";
  }
}


  // data plans
  const dataPlans = {
    "MTN": [
      { plan: "1.5GB (2 days)", price: 400 },
      { plan: "3.2GB (2 days)", price: 600 },
      { plan: "5GB (1 week)", price: 1500 },
      { plan: "10GB (1 week)", price: 3000 }
    ],
    "Airtel": [
      { plan: "2GB (2 days)", price: 500 },
      { plan: "3.2GB (2 days)", price: 600 },
      { plan: "6GB (1 week)", price: 1500 },
      { plan: "15GB (1 week)", price: 3000 }
    ],
    "Glo": [
      { plan: "1GB", price: 200 },
      { plan: "5GB", price: 600 },
      { plan: "15GB", price: 2000 },
      { plan: "20GB", price: 3000 }
    ],
    "9mobile": [
      { plan: "1GB", price: 600 },
      { plan: "2GB", price: 1100 },
      { plan: "5GB", price: 2500 },
      { plan: "10GB", price: 4600 }
    ]
  };

  // load plans
  function loadPlans(provider) {
    plansDiv.innerHTML = "";
    if (!dataPlans[provider]) {
      plansContainer.querySelector(".no-plans")?.remove();
      const msg = document.createElement("p");
      msg.className = "no-plans";
      msg.textContent = "No plans available for this provider.";
      plansContainer.prepend(msg);
      return;
    }
    plansContainer.querySelector(".no-plans")?.remove();

    dataPlans[provider].forEach(p => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "plan-btn btn btn-light";
      btn.innerHTML = `<div>${p.plan}<div style="font-size:12px;color:#333">â‚¦${p.price}</div></div>`;
      btn.onclick = () => buyData(provider, p.plan, p.price, phoneInput.value);
      plansDiv.appendChild(btn);
    });
  }

  // save + redirect logic
  function buyData(provider, plan, price, phone) {
    let user = JSON.parse(localStorage.getItem("user")) || {};
    let balance = user.balance || 0;

    const order = { network: provider, plan, price, phone };
    localStorage.setItem("order", JSON.stringify(order));

    if (balance < price) {
      Swal.fire({
        icon: 'error',
        title: 'Insufficient Balance',
        text: `You need â‚¦${price}, but your balance is â‚¦${balance}.`,
        confirmButtonText: 'Fund Wallet'
      }).then(() => window.location.href = "payment.html");
    } else {
      user.balance = balance - price;
      localStorage.setItem("user", JSON.stringify(user));
      Swal.fire({
        icon: 'success',
        title: 'Purchase Successful',
        text: `${plan} on ${provider} purchased for â‚¦${price}.`,
        timer: 2000,
        showConfirmButton: false
      }).then(() => window.location.href = "home.html");
    }
  }

  // run detection
  const phone = normalizePhone(savedUser.phone);
  phoneInput.value = phone;
  const provider = detectNetwork(phone);
  networkInput.value = provider;
  loadPlans(provider);
});
</script>
</body>
</html>
